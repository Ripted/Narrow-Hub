<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Narrow Arrow Stats Hub</title>
    <!-- Favicon: Using a target/arrow themed emoji favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéØ</text></svg>">
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --accent: #38bdf8;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --border: #334155;
            --success: #22c55e;
            --error: #ef4444;
        }

        /* Themes */
        body.theme-emerald { --accent: #10b981; }
        body.theme-rose { --accent: #f43f5e; }
        body.theme-amber { --accent: #f59e0b; }
        body.theme-purple { --accent: #a855f7; }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main);
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
        }

        .container { max-width: 1300px; margin: 0 auto; padding: 20px; }

        header { 
            text-align: center; 
            padding: 40px 0; 
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }
        h1 { font-size: 2.5rem; color: var(--accent); margin-bottom: 10px; }
        .subtitle { color: var(--text-dim); }

        /* Tabs System */
        .tabs {
            display: flex;
            gap: 5px;
            overflow-x: auto;
            margin-bottom: 30px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--border);
            scrollbar-width: thin;
        }
        .tab-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.2s;
            border-radius: 8px 8px 0 0;
        }
        .tab-btn:hover { color: var(--text-main); background: var(--border); }
        .tab-btn.active { 
            color: var(--accent); 
            border-bottom: 3px solid var(--accent);
            background: var(--card-bg);
        }

        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Grid Layouts */
        .tool-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        @media (min-width: 768px) {
            .tool-grid { grid-template-columns: 320px 1fr; }
        }

        .side-panel { display: flex; flex-direction: column; gap: 20px; }
        .main-panel { background: var(--card-bg); border-radius: 12px; padding: 25px; border: 1px solid var(--border); min-height: 600px; position: relative; }

        /* UI Elements */
        .card { 
            background: var(--card-bg); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 20px;
            margin-bottom: 15px;
        }

        .input-group { margin-bottom: 15px; }
        label { display: block; color: var(--text-dim); margin-bottom: 8px; font-size: 0.9rem; }
        input, select {
            width: 100%;
            background: #0f172a;
            border: 1px solid var(--border);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
        }
        input:focus { outline: none; border-color: var(--accent); }

        .btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: opacity 0.2s;
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover { opacity: 0.9; }
        .btn-secondary { background: var(--border); color: white; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Data Display */
        .stat-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #334155; }
        .stat-label { color: var(--text-dim); }
        .stat-value { font-weight: 600; }

        .level-card {
            background: #1e293b;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--accent);
            margin-bottom: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .level-card:hover { transform: translateX(5px); background: #2d3a4f; }
        
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .badge-accent { background: var(--accent); color: #000; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; color: var(--text-dim); padding: 12px; border-bottom: 2px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid var(--border); }
        tr:hover td { background: rgba(255, 255, 255, 0.03); }

        .loading-spinner { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 40px auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Link list styling */
        .link-item { display: flex; align-items: center; gap: 15px; padding: 15px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; text-decoration: none; color: white; background: #0f172a; transition: border-color 0.2s; }
        .link-item:hover { border-color: var(--accent); }

        .theme-circle { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid white; }

        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: -40px;">
                <div class="theme-circle" style="background: #38bdf8;" onclick="setTheme('default')"></div>
                <div class="theme-circle" style="background: #10b981;" onclick="setTheme('emerald')"></div>
                <div class="theme-circle" style="background: #f43f5e;" onclick="setTheme('rose')"></div>
                <div class="theme-circle" style="background: #f59e0b;" onclick="setTheme('amber')"></div>
            </div>
            <h1>üéØ NARROW HUB PRO</h1>
            <p class="subtitle">Unified Stats, World Records & Performance Analysis</p>
        </header>

        <nav class="tabs" id="mainTabs">
            <button class="tab-btn active" onclick="switchTab('tab-browse')">Browse</button>
            <button class="tab-btn" onclick="switchTab('tab-official')">Official Levels</button>
            <button class="tab-btn" onclick="switchTab('tab-players')">Players</button>
            <button class="tab-btn" onclick="switchTab('tab-leaderboards')">Leaderboards</button>
            <button class="tab-btn" onclick="switchTab('tab-analyzer')">Run Analyzer</button>
            <button class="tab-btn" onclick="switchTab('tab-services')">Links</button>
            <button class="tab-btn" onclick="switchTab('tab-info')">Info</button>
        </nav>

        <!-- BROWSE TAB -->
        <div id="tab-browse" class="tab-content active">
            <div class="tool-grid">
                <div class="side-panel">
                    <div class="card">
                        <h3>Discover Custom</h3>
                        <div class="input-group">
                            <label>Filter</label>
                            <select id="browseFilter">
                                <option value="popular">Popular</option>
                                <option value="new">Newest</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Page Number</label>
                            <input type="number" id="browsePageInput" value="0" min="0">
                        </div>
                        <div class="input-group">
                            <label>Keyword Search</label>
                            <input type="text" id="browseSearch" placeholder="Name or Creator...">
                        </div>
                        <button class="btn" onclick="loadLevels()">Search Levels</button>
                    </div>
                </div>
                <div class="main-panel">
                    <div id="browseResults">
                        <p style="color: var(--text-dim)">Click search to fetch custom levels.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- OFFICIAL LEVELS TAB -->
        <div id="tab-official" class="tab-content">
            <div class="tool-grid">
                <div class="side-panel">
                    <div class="card">
                        <h3>Official Maps</h3>
                        <p style="font-size: 0.9rem; color: var(--text-dim);">Browse the standard Narrow Arrow levels and current world records.</p>
                        <button class="btn" style="margin-top: 15px;" onclick="loadOfficialLevels()">Refresh List</button>
                    </div>
                </div>
                <div class="main-panel">
                    <div id="officialResults"></div>
                </div>
            </div>
        </div>

        <!-- PLAYERS TAB -->
        <div id="tab-players" class="tab-content">
            <div class="tool-grid">
                <div class="side-panel">
                    <div class="card">
                        <h3>Search Player</h3>
                        <input type="text" id="playerSearchInput" placeholder="Enter username...">
                        <button class="btn" style="margin-top: 10px;" onclick="searchPlayer()">View Profile</button>
                    </div>
                    <div class="card">
                        <h3>Compare</h3>
                        <input type="text" id="comp1" placeholder="User 1" style="margin-bottom: 5px;">
                        <input type="text" id="comp2" placeholder="User 2">
                        <button class="btn btn-secondary" style="margin-top: 10px;" onclick="comparePlayers()">Compare Stats</button>
                    </div>
                </div>
                <div class="main-panel" id="playerResults">
                    <p style="color: var(--text-dim)">Search for a player to see their detailed stats, streaks, and league status.</p>
                </div>
            </div>
        </div>

        <!-- LEADERBOARDS TAB -->
        <div id="tab-leaderboards" class="tab-content">
            <div class="main-panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Global Trophies</h2>
                    <button class="btn" style="width: auto;" onclick="loadGlobalLB()">Refresh (All Entries)</button>
                </div>
                <div id="lbResults"></div>
            </div>
        </div>

        <!-- ANALYZER TAB -->
        <div id="tab-analyzer" class="tab-content">
            <div class="tool-grid">
                <div class="side-panel">
                    <div class="card">
                        <h3>Analyze Run</h3>
                        <input type="number" id="runIdInput" placeholder="Run ID (e.g. 1844705)">
                        <button class="btn" style="margin-top: 10px;" onclick="analyzeRun()">Analyze</button>
                    </div>
                </div>
                <div class="main-panel" id="analyzerResults">
                    <p style="color: var(--text-dim)">Enter a Run ID to see details like input count, verification status, and player profile.</p>
                </div>
            </div>
        </div>

        <!-- SERVICES/LINKS TAB -->
        <div id="tab-services" class="tab-content">
            <div class="main-panel">
                <h2>Community Services</h2>
                <div style="margin-top: 20px;">
                    <a href="https://narrowarrow.xyz" target="_blank" class="link-item">
                        <span style="font-size: 1.5rem;">üéÆ</span>
                        <div>
                            <strong>Official Website</strong><br>
                            <small>Play Narrow Arrow in your browser.</small>
                        </div>
                    </a>
                    <a href="https://discord.gg/narrowarrow" target="_blank" class="link-item">
                        <span style="font-size: 1.5rem;">üí¨</span>
                        <div>
                            <strong>Discord Community</strong><br>
                            <small>Join the official Discord for news and updates.</small>
                        </div>
                    </a>
                    <a href="#" class="link-item">
                        <span style="font-size: 1.5rem;">üìä</span>
                        <div>
                            <strong>Advanced Metrics</strong><br>
                            <small>Coming soon: Graphical performance trends.</small>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- INFO TAB -->
        <div id="tab-info" class="tab-content">
            <div class="main-panel">
                <h2>About Narrow Hub</h2>
                <div style="margin-top: 20px; color: var(--text-dim);">
                    <p>Narrow Hub is a third-party analytics tool for the game Narrow Arrow. It provides real-time access to level data, player rankings, and run verification tools.</p>
                    <h3 style="color: var(--text-main); margin: 20px 0 10px;">API Integration</h3>
                    <p>We use the official Narrow Arrow API endpoints to ensure data accuracy. All stats are fetched live from the game servers.</p>
                    <h3 style="color: var(--text-main); margin: 20px 0 10px;">Tips</h3>
                    <ul style="padding-left: 20px;">
                        <li>Click on a <strong>Creator's Name</strong> in the Browse tab to view their full player profile.</li>
                        <li>Click on a <strong>Run</strong> in any leaderboard to analyze the specific inputs and verification status.</li>
                        <li>The <strong>Run ID</strong> can usually be found at the end of sharing links.</li>
                    </ul>
                </div>
            </div>
        </div>

        <footer>
            <p>Narrow Arrow Community Hub &bull; Not affiliated with the official developers.</p>
            <p style="font-size: 0.8rem; margin-top: 10px; opacity: 0.5;">API v1.2 &bull; Environment: Browser</p>
        </footer>
    </div>

    <script>
        const API_BASE = 'https://api.narrowarrow.xyz';
        const PROXY = 'https://narrow-hub.wilmer-v-123321.workers.dev/?url=';

        const OFFICIAL_LEVEL_NAMES = [
            "Arrow Factory", "Attractive Curves", "Blue Slides", "Chain Reaction", 
            "Chaotic Rally", "Colossal R", "Diamond Rally", "Dodgy Place", 
            "Energex", "Fast and Slow", "Green Cross", "Green Eyes", 
            "Highspeed Madness", "Level 1", "Level Icy", "Maze Rally", 
            "Polar Drift", "Polar Rally", "Speedrun Highway", "Spinning Square", 
            "Square Rally", "Stopzone Cycle", "Turnpike Drift", "Windmill Land"
        ];

        // Theme management
        function setTheme(theme) {
            document.body.className = theme === 'default' ? '' : `theme-${theme}`;
            localStorage.setItem('narrow-hub-theme', theme);
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            const btn = document.querySelector(`button[onclick="switchTab('${tabId}')"]`);
            if (btn) btn.classList.add('active');
            
            if (tabId === 'tab-official' && !document.getElementById('officialResults').innerHTML) {
                loadOfficialLevels();
            }
        }

        async function fetchAPI(path) {
            try {
                const response = await fetch(PROXY + encodeURIComponent(API_BASE + path));
                if (!response.ok) throw new Error('Network failure');
                return await response.json();
            } catch (e) {
                console.error("API Error:", e);
                throw e;
            }
        }

        // BROWSE LOGIC
        async function loadLevels() {
            const container = document.getElementById('browseResults');
            const filter = document.getElementById('browseFilter').value;
            const page = document.getElementById('browsePageInput').value || 0;
            const query = document.getElementById('browseSearch').value.toLowerCase();
            
            container.innerHTML = '<div class="loading-spinner"></div>';

            try {
                const levels = await fetchAPI(`/published-levels?filter=${filter}&page=${page}`);
                
                const filtered = levels.filter(l => 
                    l.name.toLowerCase().includes(query) || 
                    l.creator_name.toLowerCase().includes(query)
                );

                if (filtered.length === 0) {
                    container.innerHTML = `<p>No results found on page ${page}. Try a different page or keyword.</p>`;
                    return;
                }

                let html = `<h3>Showing Results (Page ${page})</h3><div style="margin-top:15px">`;
                filtered.forEach(l => {
                    const wrTime = (l.world_record && l.world_record.completion_time) ? l.world_record.completion_time + 's' : 'N/A';
                    html += `
                        <div class="level-card">
                            <div style="display: flex; justify-content: space-between;" onclick="goToLevel('${l.level_id}')">
                                <strong>${l.name}</strong>
                                <span class="badge badge-accent">${wrTime}</span>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-dim); margin-top: 5px;">
                                by <span style="color: var(--accent); cursor: pointer; text-decoration: underline;" onclick="goToPlayer('${l.creator_name}')">${l.creator_name}</span>
                                <span style="margin-left: 10px;">‚ù§Ô∏è ${l.like_count}</span>
                                <span style="margin-left: 10px;">üéÆ ${l.play_count}</span>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html + '</div>';
            } catch (e) {
                container.innerHTML = `<div class="error-msg">Error loading levels. API might be busy.</div>`;
            }
        }

        // OFFICIAL LEVELS
        async function loadOfficialLevels() {
            const container = document.getElementById('officialResults');
            container.innerHTML = '<div class="loading-spinner"></div>';
            
            try {
                let html = `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">`;
                
                // Fetch details for each map
                const promises = OFFICIAL_LEVEL_NAMES.map(name => fetchAPI(`/level-details/${encodeURIComponent(name)}`));
                const results = await Promise.allSettled(promises);

                results.forEach((res, idx) => {
                    if (res.status === 'fulfilled') {
                        const data = res.value;
                        const wr = data.worldRecord;
                        html += `
                            <div class="card" style="margin-bottom: 0;">
                                <h4 style="color: var(--accent);">${OFFICIAL_LEVEL_NAMES[idx]}</h4>
                                <div class="stat-row">
                                    <span class="stat-label">WR Holder</span>
                                    <span class="stat-value" onclick="goToPlayer('${wr.username}')" style="color: var(--accent); cursor: pointer;">${wr.username}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">WR Time</span>
                                    <span class="stat-value">${wr.completion_time}s</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Total Runs</span>
                                    <span class="stat-value">${data.runCount || 'N/A'}</span>
                                </div>
                                <button class="btn btn-secondary" style="margin-top: 10px; font-size: 0.8rem;" onclick="viewLevelLB('${OFFICIAL_LEVEL_NAMES[idx]}')">Full Leaderboard</button>
                            </div>
                        `;
                    }
                });
                container.innerHTML = html + '</div>';
            } catch (e) {
                container.innerHTML = `<p class="error-msg">Error loading official maps.</p>`;
            }
        }

        async function viewLevelLB(name) {
            const container = document.getElementById('officialResults');
            container.innerHTML = '<div class="loading-spinner"></div>';
            try {
                const data = await fetchAPI(`/leaderboard?levelId=${encodeURIComponent(name)}`);
                let html = `<h3>${name} Leaderboard</h3><button class="btn btn-secondary" onclick="loadOfficialLevels()" style="width: auto; margin-bottom: 10px;">Back</button><table><thead><tr><th>#</th><th>User</th><th>Time</th><th>Arrow</th></tr></thead><tbody>`;
                data.forEach((r, i) => {
                    html += `
                        <tr>
                            <td>${i+1}</td>
                            <td onclick="goToPlayer('${r.username}')" style="color: var(--accent); cursor: pointer;">${r.username}</td>
                            <td>${r.completion_time}s</td>
                            <td>${r.arrow_name}</td>
                        </tr>
                    `;
                });
                container.innerHTML = html + `</tbody></table>`;
            } catch (e) {
                container.innerHTML = `<p>Leaderboard unavailable.</p>`;
            }
        }

        // PLAYER SEARCH
        async function searchPlayer() {
            const user = document.getElementById('playerSearchInput').value.trim();
            const container = document.getElementById('playerResults');
            if (!user) return;
            container.innerHTML = '<div class="loading-spinner"></div>';
            try {
                const data = await fetchAPI(`/user/${user}`);
                container.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2>${data.user.username}</h2>
                        <span class="badge badge-accent">${data.league}</span>
                    </div>
                    <p style="color: var(--text-dim); background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px;">${data.user.bio || 'No bio available.'}</p>
                    
                    <div class="tool-grid" style="grid-template-columns: 1fr 1fr; margin-top: 20px;">
                        <div class="card">
                            <div class="stat-row"><span class="stat-label">Trophies</span><span class="stat-value">üèÜ ${data.trophies}</span></div>
                            <div class="stat-row"><span class="stat-label">Win Streak</span><span class="stat-value">üî• ${data.win_streak}</span></div>
                            <div class="stat-row"><span class="stat-label">Max Streak</span><span class="stat-value">${data.max_win_streak}</span></div>
                        </div>
                        <div class="card">
                            <div class="stat-row"><span class="stat-label">Completed</span><span class="stat-value">${data.maps_completed}</span></div>
                            <div class="stat-row"><span class="stat-label">Total Runs</span><span class="stat-value">${data.total_runs}</span></div>
                            <div class="stat-row"><span class="stat-label">Published</span><span class="stat-value">${data.published_levels_count || 0}</span></div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="window.open('https://narrowarrow.xyz/user/${data.user.username}', '_blank')">View on Web</button>
                    </div>
                `;
            } catch (e) {
                container.innerHTML = `<div class="error-msg">Player "${user}" not found. Check spelling!</div>`;
            }
        }

        function goToPlayer(user) {
            document.getElementById('playerSearchInput').value = user;
            switchTab('tab-players');
            searchPlayer();
        }

        // GLOBAL LB (Enhanced for more results)
        async function loadGlobalLB() {
            const container = document.getElementById('lbResults');
            container.innerHTML = '<div class="loading-spinner"></div>';
            try {
                const data = await fetchAPI('/leaderboard/trophies');
                // The API usually returns all indexed players if no limit is provided, or we show the whole array.
                let html = `<table><thead><tr><th>Rank</th><th>Player</th><th>Trophies</th><th>League</th></tr></thead><tbody>`;
                data.forEach((p, i) => {
                    html += `
                        <tr onclick="goToPlayer('${p.username}')" style="cursor: pointer;">
                            <td>#${i+1}</td>
                            <td style="color: var(--accent); font-weight: bold;">${p.username}</td>
                            <td>${p.trophies}</td>
                            <td><span class="badge" style="background: #334155;">${p.league}</span></td>
                        </tr>
                    `;
                });
                html += `</tbody></table>`;
                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = `<div class="error-msg">Error loading leaderboard.</div>`;
            }
        }

        // ANALYZER (Fixed player context)
        async function analyzeRun() {
            const id = document.getElementById('runIdInput').value;
            const container = document.getElementById('analyzerResults');
            if (!id) return;
            container.innerHTML = '<div class="loading-spinner"></div>';
            try {
                const data = await fetchAPI(`/runs/${id}`);
                container.innerHTML = `
                    <h2>Run #${id} Details</h2>
                    <div class="card" style="border-left: 4px solid ${data.verified ? 'var(--success)' : 'var(--error)'}">
                        <div class="stat-row">
                            <span class="stat-label">Verified</span>
                            <span class="stat-value" style="color: ${data.verified ? 'var(--success)' : 'var(--error)'}">${data.verified ? 'YES' : 'NO'}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Player</span>
                            <span class="stat-value" style="color: var(--accent); cursor: pointer;" onclick="goToPlayer('${data.username}')">${data.username || 'Loading...'}</span>
                        </div>
                        <div class="stat-row"><span class="stat-label">Map</span><span class="stat-value">${data.mapName}</span></div>
                        <div class="stat-row"><span class="stat-label">Time</span><span class="stat-value">${data.completion_time}s</span></div>
                        <div class="stat-row"><span class="stat-label">Arrow</span><span class="stat-value">${data.arrow_name}</span></div>
                        <div class="stat-row"><span class="stat-label">Inputs</span><span class="stat-value">${data.input_count}</span></div>
                    </div>
                    <div style="margin-top: 15px;">
                         <button class="btn btn-secondary" onclick="window.open('https://narrowarrow.xyz/run/${id}', '_blank')">Watch Replay</button>
                    </div>
                `;
            } catch (e) {
                container.innerHTML = `<div class="error-msg">Run ID not found or server error.</div>`;
            }
        }

        async function comparePlayers() {
            const p1 = document.getElementById('comp1').value.trim();
            const p2 = document.getElementById('comp2').value.trim();
            const container = document.getElementById('playerResults');
            if (!p1 || !p2) return;
            container.innerHTML = '<div class="loading-spinner"></div>';
            try {
                const [d1, d2] = await Promise.all([fetchAPI(`/user/${p1}`), fetchAPI(`/user/${p2}`)]);
                container.innerHTML = `
                    <h2>Comparison: ${p1} vs ${p2}</h2>
                    <table>
                        <thead>
                            <tr><th>Statistic</th><th>${p1}</th><th>${p2}</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Trophies</td><td style="color: var(--accent)">${d1.trophies}</td><td style="color: var(--accent)">${d2.trophies}</td></tr>
                            <tr><td>League</td><td>${d1.league}</td><td>${d2.league}</td></tr>
                            <tr><td>Maps Comp</td><td>${d1.maps_completed}</td><td>${d2.maps_completed}</td></tr>
                            <tr><td>Total Runs</td><td>${d1.total_runs}</td><td>${d2.total_runs}</td></tr>
                            <tr><td>Win Streak</td><td>${d1.win_streak}</td><td>${d2.win_streak}</td></tr>
                        </tbody>
                    </table>
                `;
            } catch (e) {
                container.innerHTML = `<div class="error-msg">Comparison failed. Check usernames.</div>`;
            }
        }

        // Initialize on load
        window.onload = () => {
            const savedTheme = localStorage.getItem('narrow-hub-theme');
            if (savedTheme) setTheme(savedTheme);
            
            // Allow Enter key across all inputs
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const btn = input.closest('.card, .side-panel').querySelector('button.btn');
                        if (btn) btn.click();
                    }
                });
            });
        };
    </script>
</body>
</html>
