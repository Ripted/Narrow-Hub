<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Narrow Arrow Stats Hub</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéØ</text></svg>">
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --accent: #38bdf8;
            --text: #f8fafc;
            --text-dim: #94a3b8;
            --border: #334155;
            --header-grad: linear-gradient(to right, #0f172a, #1e293b);
        }

        /* Cooler Themes */
        body.theme-pitch-black { --bg: #000000; --card: #111111; --border: #222; --accent: #ffffff; }
        body.theme-cyberpunk { --bg: #0d0221; --card: #190e4f; --accent: #00ffcc; --text: #00ffcc; --border: #540d6e; }
        body.theme-light { --bg: #f1f5f9; --card: #ffffff; --text: #0f172a; --text-dim: #64748b; --border: #e2e8f0; --accent: #2563eb; }
        body.theme-crimson { --bg: #1a0a0a; --card: #2d0f0f; --accent: #ef4444; --border: #451a1a; }
        body.theme-forest { --bg: #061006; --card: #0d200d; --accent: #22c55e; --border: #1a331a; }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background-color: var(--bg); 
            color: var(--text);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 100vh;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        header { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }
        h1 { font-size: 1.8rem; color: var(--accent); letter-spacing: -1px; }

        /* Navigation */
        .tabs {
            display: flex;
            gap: 5px;
            overflow-x: auto;
            margin-bottom: 25px;
            padding-bottom: 10px;
            scrollbar-width: none;
        }
        .tab-btn {
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            border-radius: 12px;
            white-space: nowrap;
            transition: 0.2s;
        }
        .tab-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }

        /* Main Layout */
        .tool-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 1024px) { .tool-grid { grid-template-columns: 350px 1fr; } }

        .side-panel { display: flex; flex-direction: column; gap: 20px; }
        .main-panel { background: var(--card); border-radius: 16px; padding: 25px; border: 1px solid var(--border); min-height: 700px; }

        .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; }

        /* Form Elements */
        .input-group { margin-bottom: 15px; }
        label { display: block; color: var(--text-dim); margin-bottom: 6px; font-size: 0.85rem; font-weight: 600; }
        input, select {
            width: 100%;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px;
            border-radius: 10px;
            font-size: 1rem;
        }
        input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2); }

        .btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-secondary { background: var(--border); color: var(--text); }

        /* Pagination Bar */
        .pagination-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: rgba(0,0,0,0.1);
            border-radius: 12px;
            margin-bottom: 20px;
            gap: 10px;
        }
        .page-controls { display: flex; align-items: center; gap: 10px; }
        .page-num { font-weight: bold; padding: 0 10px; }

        /* Level Cards */
        .level-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .level-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: 0.2s;
        }
        .level-item:hover { border-color: var(--accent); background: rgba(255,255,255,0.06); }
        .level-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .level-name { font-weight: bold; font-size: 1.1rem; color: var(--accent); }

        /* Settings Modal */
        #settingsModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
        }
        .modal-content { background: var(--bg); width: 90%; max-width: 500px; padding: 30px; border-radius: 24px; border: 1px solid var(--border); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .theme-option { 
            padding: 15px; 
            border: 2px solid var(--border); 
            border-radius: 12px; 
            cursor: pointer; 
            text-align: center;
            font-weight: 600;
        }
        .theme-option.active { border-color: var(--accent); background: rgba(56, 189, 248, 0.1); }

        /* Specific Table Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; border-radius: 12px; overflow: hidden; }
        th { text-align: left; padding: 15px; background: rgba(0,0,0,0.2); color: var(--text-dim); }
        td { padding: 15px; border-bottom: 1px solid var(--border); }
        tr:last-child td { border: none; }
        tr:hover td { background: rgba(255,255,255,0.02); }

        /* Loader */
        .loading-spinner { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 40px auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>üéØ NARROW HUB v2</h1>
                <p style="color: var(--text-dim); font-size: 0.8rem;">Official API Integrated Analytics</p>
            </div>
            <button class="btn btn-secondary" style="width: auto;" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
        </header>

        <nav class="tabs" id="mainTabs">
            <button class="tab-btn active" onclick="switchTab('tab-browse')">Browse</button>
            <button class="tab-btn" onclick="switchTab('tab-official')">Official</button>
            <button class="tab-btn" onclick="switchTab('tab-players')">Players</button>
            <button class="tab-btn" onclick="switchTab('tab-leaderboards')">Leaderboards</button>
            <button class="tab-btn" onclick="switchTab('tab-analyzer')">Analyzer</button>
        </nav>

        <!-- BROWSE TAB -->
        <div id="tab-browse" class="tab-content active">
            <div class="tool-grid">
                <div class="side-panel">
                    <div class="card">
                        <h3>Filter & Search</h3>
                        <div class="input-group">
                            <label>Sort By</label>
                            <select id="browseFilter" onchange="loadLevels(0)">
                                <option value="popular">Popular</option>
                                <option value="new">Newest</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Keyword Search</label>
                            <input type="text" id="browseSearch" placeholder="Level name...">
                        </div>
                        <div class="input-group">
                            <label>Search by Creator</label>
                            <input type="text" id="creatorSearch" placeholder="Creator username...">
                        </div>
                        <button class="btn" onclick="loadLevels(0)">Refresh Results</button>
                    </div>

                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3>Autoload</h3>
                            <input type="checkbox" id="autoloadToggle" style="width: auto;" onchange="handleAutoload()">
                        </div>
                        <label>Interval (Seconds)</label>
                        <select id="autoloadInterval">
                            <option value="2000">2s</option>
                            <option value="5000" selected>5s</option>
                            <option value="10000">10s</option>
                        </select>
                        <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 10px;">Automatically jumps to the next page of results.</p>
                    </div>
                </div>

                <div class="main-panel">
                    <div class="pagination-bar">
                        <button class="btn btn-secondary" style="width: auto;" onclick="changePage(-1)">‚Üê Previous</button>
                        <div class="page-controls">
                            Page <span id="currentPageNum" class="page-num">0</span>
                        </div>
                        <button class="btn btn-secondary" style="width: auto;" onclick="changePage(1)">Next ‚Üí</button>
                    </div>
                    <div id="browseResults" class="level-list"></div>
                </div>
            </div>
        </div>

        <!-- OFFICIAL TAB -->
        <div id="tab-official" class="tab-content">
            <div class="main-panel">
                <div id="officialView">
                    <h2 style="margin-bottom: 20px;">Official World Records</h2>
                    <div id="officialResults" class="level-list"></div>
                </div>
                <div id="officialDetails" class="hidden">
                    <!-- Detail View -->
                </div>
            </div>
        </div>

        <!-- PLAYER TAB -->
        <div id="tab-players" class="tab-content">
            <div class="tool-grid">
                <div class="side-panel">
                    <div class="card">
                        <h3>Profile Search</h3>
                        <input type="text" id="playerSearchInput" placeholder="Username...">
                        <button class="btn" style="margin-top: 10px;" onclick="searchPlayer()">View Stats</button>
                    </div>
                </div>
                <div class="main-panel" id="playerResults">
                    <p style="color: var(--text-dim)">Search a player to see trophies, streaks, and ranking.</p>
                </div>
            </div>
        </div>

        <!-- LEADERBOARDS TAB -->
        <div id="tab-leaderboards" class="tab-content">
            <div class="main-panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Global Rankings</h2>
                    <button class="btn" style="width: auto;" onclick="loadGlobalLB()">Refresh All</button>
                </div>
                <div id="lbResults"></div>
            </div>
        </div>

        <!-- ANALYZER TAB -->
        <div id="tab-analyzer" class="tab-content">
            <div class="tool-grid">
                <div class="side-panel">
                    <div class="card">
                        <h3>Run Verification</h3>
                        <input type="number" id="runIdInput" placeholder="Run ID...">
                        <button class="btn" style="margin-top: 10px;" onclick="analyzeRun()">Verify Data</button>
                    </div>
                </div>
                <div class="main-panel" id="analyzerResults"></div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 style="margin-bottom: 20px;">Appearance Settings</h2>
            <div class="theme-grid">
                <div class="theme-option" onclick="setTheme('default')">Deep Slate</div>
                <div class="theme-option" onclick="setTheme('pitch-black')">Pitch Black</div>
                <div class="theme-option" onclick="setTheme('cyberpunk')">Cyberpunk</div>
                <div class="theme-option" onclick="setTheme('light')">Pure Light</div>
                <div class="theme-option" onclick="setTheme('crimson')">Crimson</div>
                <div class="theme-option" onclick="setTheme('forest')">Forest</div>
            </div>
            <button class="btn" style="margin-top: 30px;" onclick="toggleSettings()">Save & Close</button>
        </div>
    </div>

    <script>
        const API_BASE = 'https://api.narrowarrow.xyz';
        const PROXY = 'https://narrow-hub.wilmer-v-123321.workers.dev/?url=';
        
        let currentPage = 0;
        let autoloadTimer = null;

        const OFFICIAL_LEVELS = [
            "Arrow Factory", "Attractive Curves", "Blue Slides", "Chain Reaction", 
            "Chaotic Rally", "Colossal R", "Diamond Rally", "Dodgy Place", 
            "Energex", "Fast and Slow", "Green Cross", "Green Eyes", 
            "Highspeed Madness", "Level 1", "Level Icy", "Maze Rally", 
            "Polar Drift", "Polar Rally", "Speedrun Highway", "Spinning Square", 
            "Square Rally", "Stopzone Cycle", "Turnpike Drift", "Windmill Land"
        ];

        // --- THEME ENGINE ---
        function setTheme(theme) {
            document.body.className = theme === 'default' ? '' : `theme-${theme}`;
            localStorage.setItem('nh-theme', theme);
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.toggle('active', opt.textContent.toLowerCase().includes(theme.replace('-',' ')));
            });
        }

        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }

        function closeModal(e) {
            if(e.target.id === 'settingsModal') toggleSettings();
        }

        // --- NAVIGATION ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            const btn = document.querySelector(`button[onclick="switchTab('${tabId}')"]`);
            if (btn) btn.classList.add('active');
            
            if (tabId === 'tab-browse' && !document.getElementById('browseResults').innerHTML) loadLevels(0);
            if (tabId === 'tab-official' && !document.getElementById('officialResults').innerHTML) loadOfficialList();
        }

        async function fetchAPI(path) {
            try {
                const response = await fetch(PROXY + encodeURIComponent(API_BASE + path));
                if (!response.ok) throw new Error('API failure');
                return await response.json();
            } catch (e) {
                console.error("API Error:", e);
                return null;
            }
        }

        // --- LEVEL BROWSER ---
        async function loadLevels(page) {
            currentPage = page;
            document.getElementById('currentPageNum').innerText = currentPage;
            const container = document.getElementById('browseResults');
            const filter = document.getElementById('browseFilter').value;
            const query = document.getElementById('browseSearch').value.toLowerCase();
            const creator = document.getElementById('creatorSearch').value.toLowerCase();
            
            container.innerHTML = '<div class="loading-spinner"></div>';

            const levels = await fetchAPI(`/published-levels?filter=${filter}&page=${currentPage}`);
            if (!levels) return container.innerHTML = "Failed to load.";

            let filtered = levels;
            if (query) filtered = filtered.filter(l => l.name.toLowerCase().includes(query));
            if (creator) filtered = filtered.filter(l => l.creator_name.toLowerCase().includes(creator));

            if (filtered.length === 0) {
                container.innerHTML = `<p style="grid-column: 1/-1; text-align: center;">No levels found on page ${currentPage}.</p>`;
                return;
            }

            container.innerHTML = filtered.map(l => `
                <div class="level-item" onclick="viewLevelDetail('${l.level_id}')">
                    <div class="level-header">
                        <span class="level-name">${l.name}</span>
                        <span style="font-size: 0.7rem; color: var(--text-dim)">#${l.level_id}</span>
                    </div>
                    <div style="font-size: 0.85rem; margin-bottom: 10px;">
                        by <span style="color: var(--accent)" onclick="event.stopPropagation(); goToPlayer('${l.creator_name}')">${l.creator_name}</span>
                    </div>
                    <div style="display: flex; gap: 15px; font-size: 0.8rem; color: var(--text-dim);">
                        <span>‚ù§Ô∏è ${l.like_count}</span>
                        <span>üéÆ ${l.play_count}</span>
                        <span style="color: var(--text)">üèÜ ${l.world_record?.completion_time || 'N/A'}s</span>
                    </div>
                </div>
            `).join('');
        }

        function changePage(delta) {
            currentPage = Math.max(0, currentPage + delta);
            loadLevels(currentPage);
        }

        // --- AUTOLOAD ---
        function handleAutoload() {
            const isEnabled = document.getElementById('autoloadToggle').checked;
            const interval = parseInt(document.getElementById('autoloadInterval').value);
            
            if (autoloadTimer) clearInterval(autoloadTimer);
            
            if (isEnabled) {
                autoloadTimer = setInterval(() => {
                    changePage(1);
                }, interval);
            }
        }

        // --- LEVEL DETAILS (NEW FEATURE) ---
        async function viewLevelDetail(levelId) {
            const container = document.getElementById('browseResults');
            const nav = document.querySelector('.pagination-bar');
            nav.classList.add('hidden');
            container.innerHTML = '<div class="loading-spinner"></div>';
            
            // Note: Official levels use names, Published use IDs
            const data = await fetchAPI(`/published-level-details/${levelId}`);
            if (!data) return loadLevels(currentPage);

            container.style.display = 'block';
            container.innerHTML = `
                <div class="card">
                    <button class="btn btn-secondary" style="width: auto; margin-bottom: 20px;" onclick="closeDetails()">‚Üê Back to Browser</button>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h1>${data.name}</h1>
                        <span style="color: var(--accent); font-weight: bold;">WR: ${data.world_record?.completion_time || 'N/A'}s</span>
                    </div>
                    <p style="margin: 10px 0; color: var(--text-dim);">Level ID: ${data.level_id} | Created by: <span style="color: var(--accent); cursor: pointer;" onclick="goToPlayer('${data.creator_name}')">${data.creator_name}</span></p>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0;">
                        <div class="card" style="text-align: center;"><h3>${data.play_count}</h3><small>Plays</small></div>
                        <div class="card" style="text-align: center;"><h3>${data.like_count}</h3><small>Likes</small></div>
                        <div class="card" style="text-align: center;"><h3>${data.total_attempts || 'N/A'}</h3><small>Total Attempts</small></div>
                    </div>
                    
                    <h3 style="margin-top: 30px;">Top 50 Leaderboard</h3>
                    <div id="levelLB">Loading LB...</div>
                </div>
            `;

            const lb = await fetchAPI(`/leaderboard?levelId=${levelId}`);
            const lbDiv = document.getElementById('levelLB');
            if (!lb || lb.length === 0) lbDiv.innerHTML = "No runs recorded yet.";
            else {
                lbDiv.innerHTML = `<table><thead><tr><th>#</th><th>Player</th><th>Time</th><th>Arrow</th></tr></thead><tbody>
                    ${lb.map((r, i) => `<tr><td>${i+1}</td><td onclick="goToPlayer('${r.username}')" style="color: var(--accent); cursor:pointer">${r.username}</td><td>${r.completion_time}s</td><td>${r.arrow_name}</td></tr>`).join('')}
                </tbody></table>`;
            }
        }

        function closeDetails() {
            document.getElementById('browseResults').style.display = 'grid';
            document.querySelector('.pagination-bar').classList.remove('hidden');
            loadLevels(currentPage);
        }

        // --- OFFICIAL LEVELS ---
        async function loadOfficialList() {
            const container = document.getElementById('officialResults');
            container.innerHTML = '<div class="loading-spinner"></div>';
            
            const promises = OFFICIAL_LEVELS.map(name => fetchAPI(`/level-details/${encodeURIComponent(name)}`));
            const results = await Promise.allSettled(promises);

            container.innerHTML = results.map((res, idx) => {
                if (res.status === 'fulfilled' && res.value) {
                    const data = res.value;
                    const wr = data.worldRecord;
                    return `
                        <div class="level-item" onclick="viewOfficialLB('${OFFICIAL_LEVELS[idx]}')">
                            <div class="level-name">${OFFICIAL_LEVELS[idx]}</div>
                            <div style="font-size: 0.8rem; margin: 8px 0;">WR: <span style="color: var(--accent)">${wr.username}</span></div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; opacity: 0.7;">
                                <span>${wr.completion_time}s</span>
                                <span>Runs: ${data.runCount || 0}</span>
                            </div>
                        </div>
                    `;
                }
                return '';
            }).join('');
        }

        async function viewOfficialLB(name) {
            const main = document.getElementById('officialView');
            const detail = document.getElementById('officialDetails');
            main.classList.add('hidden');
            detail.classList.remove('hidden');
            detail.innerHTML = '<div class="loading-spinner"></div>';

            const lb = await fetchAPI(`/leaderboard/${encodeURIComponent(name)}`);
            detail.innerHTML = `
                <button class="btn btn-secondary" style="width: auto; margin-bottom: 20px;" onclick="closeOfficialDetail()">‚Üê Back to Official</button>
                <h2>${name} Leaderboard</h2>
                <table><thead><tr><th>Rank</th><th>Player</th><th>Time</th><th>Verification</th></tr></thead><tbody>
                    ${lb.map((r, i) => `
                        <tr>
                            <td>#${i+1}</td>
                            <td onclick="goToPlayer('${r.username}')" style="color: var(--accent); cursor: pointer;">${r.username}</td>
                            <td>${r.completion_time}s</td>
                            <td>${r.verified ? '‚úÖ' : '‚ùå'}</td>
                        </tr>
                    `).join('')}
                </tbody></table>
            `;
        }

        function closeOfficialDetail() {
            document.getElementById('officialView').classList.remove('hidden');
            document.getElementById('officialDetails').classList.add('hidden');
        }

        // --- PLAYERS ---
        async function searchPlayer() {
            const user = document.getElementById('playerSearchInput').value.trim();
            const container = document.getElementById('playerResults');
            if (!user) return;
            container.innerHTML = '<div class="loading-spinner"></div>';
            const data = await fetchAPI(`/user/${user}`);
            if (!data) return container.innerHTML = "Player not found.";

            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h1 style="color: var(--accent)">${data.user.username}</h1>
                        <span class="badge" style="background: var(--border); padding: 4px 10px; border-radius: 6px;">${data.league}</span>
                    </div>
                    <div style="text-align: right;">
                        <h2 style="color: var(--accent)">üèÜ ${data.trophies}</h2>
                        <small style="color: var(--text-dim)">Global Rank: #${data.rank || '???'}</small>
                    </div>
                </div>
                <div class="card" style="margin-bottom: 15px;">
                    <p>${data.user.bio || 'This user prefers to keep a low profile.'}</p>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                    <div class="card"><h4>${data.win_streak}</h4><small>Win Streak</small></div>
                    <div class="card"><h4>${data.maps_completed}</h4><small>Completed</small></div>
                    <div class="card"><h4>${data.total_runs}</h4><small>Total Runs</small></div>
                    <div class="card"><h4>${data.published_levels_count || 0}</h4><small>Published</small></div>
                </div>
            `;
        }

        function goToPlayer(user) {
            document.getElementById('playerSearchInput').value = user;
            switchTab('tab-players');
            searchPlayer();
        }

        // --- GLOBAL LB ---
        async function loadGlobalLB() {
            const container = document.getElementById('lbResults');
            container.innerHTML = '<div class="loading-spinner"></div>';
            const data = await fetchAPI('/leaderboard/trophies');
            if (!data) return;

            container.innerHTML = `<table><thead><tr><th>Rank</th><th>Player</th><th>Trophies</th><th>League</th></tr></thead><tbody>
                ${data.map((p, i) => `
                    <tr onclick="goToPlayer('${p.username}')" style="cursor: pointer">
                        <td>#${i+1}</td>
                        <td style="color: var(--accent); font-weight: bold;">${p.username}</td>
                        <td>${p.trophies}</td>
                        <td>${p.league}</td>
                    </tr>
                `).join('')}
            </tbody></table>`;
        }

        // --- ANALYZER ---
        async function analyzeRun() {
            const id = document.getElementById('runIdInput').value;
            const container = document.getElementById('analyzerResults');
            if (!id) return;
            container.innerHTML = '<div class="loading-spinner"></div>';
            const data = await fetchAPI(`/runs/${id}`);
            if (!data) return container.innerHTML = "Run not found.";

            container.innerHTML = `
                <div class="card" style="border-left: 8px solid ${data.verified ? '#22c55e' : '#ef4444'}">
                    <h2>Run #${id} [${data.verified ? 'VERIFIED' : 'UNVERIFIED'}]</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div>
                            <p><strong>Player:</strong> <span style="color: var(--accent); cursor: pointer;" onclick="goToPlayer('${data.username}')">${data.username}</span></p>
                            <p><strong>Map:</strong> ${data.mapName}</p>
                            <p><strong>Arrow:</strong> ${data.arrow_name}</p>
                        </div>
                        <div>
                            <p><strong>Time:</strong> ${data.completion_time}s</p>
                            <p><strong>Inputs:</strong> ${data.input_count}</p>
                            <p><strong>Date:</strong> ${new Date(data.date).toLocaleDateString()}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        window.onload = () => {
            const savedTheme = localStorage.getItem('nh-theme');
            if (savedTheme) setTheme(savedTheme);
            loadLevels(0);

            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const card = input.closest('.card');
                        const btn = card ? card.querySelector('.btn') : null;
                        if (btn) btn.click();
                    }
                });
            });
        };
    </script>
</body>
</html>
